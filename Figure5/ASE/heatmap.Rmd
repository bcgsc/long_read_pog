---
title: "Generate ASE heatmap"
author: "Glenn Chang"
output: html_document
---

```{r setup, include=TRUE}
suppressMessages(library(pheatmap))
suppressMessages(library(ConsensusClusterPlus))
suppressMessages(library(RColorBrewer))
suppressMessages(library(tidyverse))


resultData <- read.delim("ref/imputedASEMatrix_anonymize.tsv")
gene_annotation <- read.delim("ref/hg38_gene_annotation.bed", header = F)
Xgene <- gene_annotation %>%
  dplyr::filter(V1 == "chrX") %>%
  pull(V4)
sample_metadata <- read.delim("ref/sample_metadata.tsv")
imprinting <- read.delim("ref/imprintedGene.txt")
```

## Intro

This R markdown is used to generate the heatmap from supplemental figure X. As many genes are unphased, the missforest package is used to impute the data for clustering. Only the 1000 most variable genes are shown in the heatmap.  

```{r get-gene}
resultData <- resultData[, !colnames(resultData) %in% Xgene]
result_t <- t(resultData)
numGene <- 1000
v <- names(sort(apply(result_t,1,var), decreasing=T)[1:numGene])
gene_var <- result_t[row.names(result_t) %in% v, ]
```

## Cluster using ConsensusClusterPlus. 
Uses K=5 groups for clustering.
```{r}
# Set your variables
pitem=0.8
pfeature=0.8
reps=1000
distance="pearson"
method="ward.D2"
maxk=8
clusteralg="hc"

# Run CCP
gene_ccp <- ConsensusClusterPlus(as.matrix(gene_var),
                                 maxK=maxk, 
                                 reps=reps, 
                                 pItem=pitem, 
                                 pFeature=pfeature, 
                                 clusterAlg=clusteralg, 
                                 distance=distance, 
                                 innerLinkage=method, 
                                 finalLinkage=method)
cluster_num <- 5

membership <- as.data.frame(gene_ccp[[cluster_num]]$consensusClass[gene_ccp[[cluster_num]]$consensusTree[["order"]]])
colnames(membership) <- "cluster"
```
## Add column annotation (sample metadata)
```{r}
annot <- sample_metadata %>%
  dplyr::select(Anonymous_ID, ploidy_num, Frac_nondiploid,tumour_content, Tumour_type_3letter)%>%
  dplyr::filter(Anonymous_ID %in% colnames(gene_var)) %>%
  distinct(Anonymous_ID, .keep_all=TRUE) %>%
  column_to_rownames("Anonymous_ID")

anno_clust <- cbind(membership, annot[row.names(membership),])
gene_clust <- gene_var[,rownames(anno_clust)]
```


## Add row annotation
Add chromosome number and if it is imprinting
```{r}
annot_row <- gene_annotation %>%
  dplyr::select(V4, V1) %>%
  `colnames<-`(c("gene", "chromsome")) %>%
  distinct() %>%
  dplyr::filter(gene %in% rownames(gene_clust)) %>%
  dplyr::mutate(imprinting = as.numeric(gene %in% imprinting$`Gene name`)) %>%
  column_to_rownames("gene")
```


# Plot heatmap
```{r}
clust_method="ward.D2"

# Color map
rc1 <- colorRampPalette(colors = c("dodgerblue3", "white"))(30)    
rc2 <- colorRampPalette(colors = c("white", "red3"))(69)
rampcols <- c(rc1, rc2)
rb1 <- seq(0.5, 0.65, length.out=30)
rb2 <- seq(0.65, 1, length.out=70)[-1]
rampbreaks <- c(rb1, rb2)

heat <- pheatmap(gene_clust, 
                 breaks = rampbreaks,
                 color = rampcols, 
                 cluster_rows = TRUE, cluster_cols = FALSE, 
                 show_rownames = FALSE, show_colnames = FALSE, 
                 annotation_col = anno_clust, 
                 annotation_row = annot_row, annotation_names_row = T,
                 annotation_legend = F, annotation_names_col = TRUE, 
                 clustering_method = clust_method, 
                 border=NA)
```

# Stats 
Correlation with cluster number and fraction of nondiploid
```{r}
cluster <- membership %>%
  rownames_to_column("sample") %>%
  left_join(rownames_to_column(annot, "sample"), by = c("sample" = "sample")) %>%
  dplyr::mutate(cluster = as.character(cluster))

res.aov2 <- aov(Frac_nondiploid ~ cluster , data = cluster)
summary(res.aov2)
```

```{r}
cluster %>%
  ggplot(aes(reorder(cluster, Frac_nondiploid, mean), Frac_nondiploid)) + 
  geom_boxplot() + 
  xlab("Cluster number")
```


Cluster correlation with fraction of nondiploid
```{r}
res.aov2 <- aov(tumour_content ~ cluster , data = cluster)
summary(res.aov2)
```

```{r}
cluster %>%
  ggplot(aes(reorder(cluster, tumour_content, mean), tumour_content)) + 
  geom_boxplot() + 
  xlab("Cluster number")
```
